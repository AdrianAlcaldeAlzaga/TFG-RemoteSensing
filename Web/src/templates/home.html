{% extends "base.html" %}

{% block title %}Home - Consultar Coordenadas{% endblock %}

{% block customCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/home.css') }}">
{% endblock %}

{% block body %}
<div class="container mt-5">
    <!-- Encabezado con información del usuario -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Consultar Coordenadas</h1>
            <p class="text-muted mb-0">Sistema de Análisis de Embeddings Satelitales</p>
        </div>
        <div>
            <span class="badge bg-primary fs-6 me-2">
                <i class="bi bi-person-circle"></i> {{ current_user.username }}
            </span>
            <a class="btn btn-outline-danger btn-sm" href="{{ url_for('logout') }}">
                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
            </a>
        </div>
    </div>

    <!-- Formulario estilizado -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-geo-alt-fill"></i> Introducir Coordenadas
            </h5>
        </div>
        <div class="card-body">
            <form id="coordForm">
                <div class="row g-3">
                    <!-- Latitud -->
                    <div class="col-md-4">
                        <label for="lat" class="form-label fw-bold">
                            <i class="bi bi-compass"></i> Latitud
                        </label>
                        <input 
                            type="number" 
                            class="form-control form-control-lg" 
                            id="lat" 
                            name="lat" 
                            step="0.000001" 
                            min="-90" 
                            max="90"
                            placeholder="Ej: 40.416775"
                            required>
                        <div class="form-text">Rango: -90° a 90°</div>
                    </div>
                    
                    <!-- Longitud -->
                    <div class="col-md-4">
                        <label for="lon" class="form-label fw-bold">
                            <i class="bi bi-compass"></i> Longitud
                        </label>
                        <input 
                            type="number" 
                            class="form-control form-control-lg" 
                            id="lon" 
                            name="lon" 
                            step="0.000001" 
                            min="-180" 
                            max="180"
                            placeholder="Ej: -3.703790"
                            required>
                        <div class="form-text">Rango: -180° a 180°</div>
                    </div>

                    <!-- Año -->
                    <div class="col-md-4">
                        <label for="year" class="form-label fw-bold">
                            <i class="bi bi-calendar-event"></i> Año
                        </label>
                        <input 
                            type="number" 
                            class="form-control form-control-lg" 
                            id="year" 
                            name="year" 
                            min="2017" 
                            max="2024"
                            value="2024"
                            placeholder="2024">
                        <div class="form-text">Rango: 2017 a 2024</div>
                    </div>
                </div>

                <!-- Botón de búsqueda -->
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-search"></i> Buscar Embeddings
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Área de resultados -->
    <div id="resultado"></div>
</div>

<script>
// Función para establecer coordenadas de ejemplo
function setCoords(lat, lon) {
    document.getElementById('lat').value = lat;
    document.getElementById('lon').value = lon;
}

document.getElementById('coordForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const lat = document.getElementById('lat').value;
    const lon = document.getElementById('lon').value;
    const user = "{{ current_user.username }}";
    const year = document.getElementById('year').value || 2024;

    // Mostrar "Cargando..." con spinner
    document.getElementById('resultado').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-muted">Obteniendo embeddings de Earth Engine...</p>
        </div>
    `;

    // Hacer la petición GET a la API
    fetch(`/api/alphaearth/points?lat=${lat}&lon=${lon}&user=${user}&year=${year}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la petición: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        mostrarResultados(data);
    })
    .catch(error => {
        document.getElementById('resultado').innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> Error
                </h5>
                <p><strong>No se pudieron obtener los datos:</strong> ${error.message}</p>
                <hr>
                <p class="mb-0">Por favor, verifica las coordenadas e intenta nuevamente.</p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    });
});

function mostrarResultados(data) {
    const embeddings = data.data.embeddings;
    const embeddingsKeys = Object.keys(embeddings);
    
    const html = `
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle-fill"></i> Resultados Obtenidos
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Latitud</th>
                                <th>Longitud</th>
                                <th>Año</th>
                                <th>Es Residuo</th>
                                <th>Tipo Residuo</th>
                                <th>Origen</th>
                                ${embeddingsKeys.map(key => `<th>${key}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${data.data.latitud}</td>
                                <td>${data.data.longitud}</td>
                                <td>${data.data.anio}</td>
                                <td>${data.data.es_residuo ? 'Sí' : 'No'}</td>
                                <td>${data.data.tipo_residuo}</td>
                                <td><span class="badge bg-${data.origen === 'base_de_datos' ? 'info' : 'warning'}">${data.origen}</span></td>
                                ${embeddingsKeys.map(key => `<td>${embeddings[key].toFixed(6)}</td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small>
                    <i class="bi bi-info-circle"></i> 
                    Total de embeddings: <strong>${embeddingsKeys.length}</strong> | 
                    Usuario: <strong>${data.user}</strong>
                </small>
            </div>
        </div>
    `;
    
    document.getElementById('resultado').innerHTML = html;
}
</script>
{% endblock %}